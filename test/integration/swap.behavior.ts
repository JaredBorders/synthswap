import { expect } from "chai";
import { ethers, artifacts, waffle, network } from "hardhat";
import dotenv from "dotenv";

dotenv.config();

// constructor variables
const SYNTHETIX_PROXY = "0xC011a73ee8576Fb46F5E1c5751cA3B9Fe0af2a6F"; // ProxyERC20
const SUSD_PROXY = "0x57Ab1ec28D129707052df4dF418D58a2D46d5f51"; // ProxyERC20sUSD
const VOLUME_REWARDS = ethers.constants.AddressZero;
const AGGREGATION_ROUTER_V3 = "0x11111112542d85b3ef69ae05771c2dccff4faa26";
const ADDRESS_RESOLVER = "0x823bE81bbF96BEc0e25CA13170F5AaCb5B79ba83"

const TEST_ADDRESS = "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE"; // Make sure it has ETH
const SETH_PROXY = "0x5e74c9036fb86bd7ecdcb084a0673efc32ea31cb";
const TRANSACTION_PAYLOAD_1INCH =
    "0x7c02520000000000000000000000000027239549dd40e1d60f5b80b0c4196923745b1fd200000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000057ab1ec28d129707052df4df418d58a2d46d5f5100000000000000000000000027239549dd40e1d60f5b80b0c4196923745b1fd2000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa000000000000000000000000000000000000000000000000016345785d8a00000000000000000000000000000000000000000000000000148b78263105efae3f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000003a0000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000004d0e30db000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000f80758ab42c3b07da84053fd88804bcb6baa4b5c000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000a4b757fed6000000000000000000000000f80758ab42c3b07da84053fd88804bcb6baa4b5c000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000057ab1ec28d129707052df4df418d58a2d46d5f510000000000000000002dc6c027239549dd40e1d60f5b80b0c4196923745b1fd200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000184b3af37c00000000000000000000000000000000000000000000000000000000000000080800000000000000000000000000000000000000000000000000000000000002400000000000000000000000057ab1ec28d129707052df4df418d58a2d46d5f51000000000000000000000000000000010000000000000000000000000000000100000000000000000000000057ab1ec28d129707052df4df418d58a2d46d5f510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
const SETH_BYTES32 = "0x7345544800000000000000000000000000000000000000000000000000000000";

describe("Integration: Test Synthswap.sol", function () {
    before(async () => {
        await network.provider.request({
            method: "hardhat_reset",
            params: [
                {
                    forking: {
                        jsonRpcUrl: process.env.ARCHIVE_NODE_URL,
                        blockNumber: 13768323,
                    },
                },
            ],
        });

        await network.provider.request({
            method: "hardhat_impersonateAccount",
            params: [TEST_ADDRESS],
        });
    });

    it("Test swap out of ETH into sETH", async () => {
        const SynthSwap = await ethers.getContractFactory("SynthSwap");
        const synthswap = await SynthSwap.deploy(
            SYNTHETIX_PROXY,
            SUSD_PROXY,
            VOLUME_REWARDS,
            AGGREGATION_ROUTER_V3,
            ADDRESS_RESOLVER
        );
        await synthswap.deployed();

        const IERC20ABI = (await artifacts.readArtifact("IERC20")).abi;
        const mockProvider = waffle.provider;
        const sETH = new ethers.Contract(SETH_PROXY, IERC20ABI, mockProvider);
        
        // pre-swap balance
        const preBalance = await sETH.balanceOf(TEST_ADDRESS);

        // Replace 0xaaa... placeholder from generated payload with deployed Synthswap address.
        // This is because when generating the 1inch payload we need to specify a destination receiver address,
        // which is our Synthswap contract, and this is not known ahead of time.
        const TRANSACTION_PAYLOAD_1INCH_WITH_DEST_AS_CONTRACT =
            TRANSACTION_PAYLOAD_1INCH.replace(
                /aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa/g,
                synthswap.address.substring(2) // Slice off "0x"
            );

        const signer = await ethers.getSigner(TEST_ADDRESS);

        await synthswap
            .connect(signer) // Call swap from TEST_ADDRESS
            .swapInto(
                SETH_BYTES32,
                TRANSACTION_PAYLOAD_1INCH_WITH_DEST_AS_CONTRACT,
                {
                    gasLimit: 1000000, // If tx reverts increase gas limit
                    value: ethers.BigNumber.from("100000000000000000"),
                }
            );
        
        // post-swap balance
        const postBalance = await sETH.balanceOf(TEST_ADDRESS);

        // Check ETH balance increased
        expect(postBalance).to.be.above(preBalance);
        expect(postBalance.toString()).to.equal("98802617794637161");
    });
});
